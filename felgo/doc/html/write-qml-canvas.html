<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- sdlgfx-port.qdoc -->
  <title>Chapter 3: Write a QML Canvas object that mimics a SDL_gfx-like API | felgo-neurocid</title>
</head>
<body>
<div class="sidebar"><div class="sidebar-content" id="sidebar-content"></div></div>
<h1 class="title">Chapter 3: Write a QML Canvas object that mimics a SDL_gfx-like API</h1>
<span class="subtitle"></span>
<!-- $$$write_qml_canvas.html-description -->
<div class="descr"> <a name="details"></a>
<p>SDL_gfx provides a simple and straight-forward <a href="https://www.ferzkopp.net/Software/SDL_gfx-2.0/Docs/html/_s_d_l__gfx_primitives_8h.html">API</a> for rasterising vector graphics. What we need to do is extend a QML Canvas with methods resembling the SDL_gfx-functions we require. Let's say for the sake of simplicity we require straight-lines only. The following sections shows an example of QML Canvas that supports exactly that. Please note that the renderTarget and renderStrategy are educated guesses and that the helper functions preceding the function lineRGBA are required to generate html color-hex-strings (e.g: &quot;#ff0000&quot; for pure red), to clear the whole canvas and to control the framebuffer. You can find the full implementation in <a href="qml-gfxcanvas.html">GfxCanvas</a></p>
<pre class="qml"><span class="type">Canvas</span> {
    <span class="name">renderTarget</span>: <span class="name">Canvas</span>.<span class="name">Image</span>;
    <span class="name">renderStrategy</span>: <span class="name">Canvas</span>.<span class="name">Immediate</span>;
    <span class="comment">//VERY important. we need the objectName so we can find the object in the C++ code.</span>
    <span class="name">objectName</span>: <span class="string">&quot;gfxCanvas&quot;</span>

    <span class="comment">//Creates a hex string from an integer value with a value from 0 to 255. If the resulting</span>
    <span class="comment">//string consists of only one character a leading zero is added.</span>
    <span class="keyword">function</span> <span class="name">makePadded8BitHexString</span>(v) {
        <span class="keyword">if</span>(<span class="name">v</span> <span class="operator">&lt;</span> <span class="number">0</span> <span class="operator">||</span> <span class="name">v</span> <span class="operator">&gt;</span> <span class="number">255</span>) {
            <span class="name">console</span>.<span class="name">error</span>(<span class="string">&quot;makePadded8BitHexString: value out of bounds&quot;</span>);
            <span class="keyword">return</span> <span class="string">&quot;00&quot;</span>;
        } <span class="keyword">else</span> {
            var vHex = <span class="name">v</span>.<span class="name">toString</span>(<span class="number">16</span>);
            <span class="keyword">if</span>(<span class="name">vHex</span>.<span class="name">length</span> <span class="operator">===</span> <span class="number">1</span>) {
                <span class="keyword">return</span> <span class="string">&quot;0&quot;</span> <span class="operator">+</span> <span class="name">vHex</span>;
            } <span class="keyword">else</span> {
                <span class="keyword">return</span> <span class="name">vHex</span>;
            }
        }
    }

    <span class="comment">//Creates an html like rgb hex-string. e.g.: &quot;#ff0000&quot; for pure red</span>
    <span class="keyword">function</span> <span class="name">makeHtmlColorString</span>(r, g, b) {
        <span class="keyword">return</span> <span class="string">&quot;#&quot;</span> <span class="operator">+</span> <span class="name">makePadded8BitHexString</span>(<span class="name">r</span>) <span class="operator">+</span>
                <span class="name">makePadded8BitHexString</span>(<span class="name">g</span>) <span class="operator">+</span>
                <span class="name">makePadded8BitHexString</span>(<span class="name">b</span>)
    }

    <span class="comment">//Sets the fill and stroke color of the 2d context.</span>
    <span class="keyword">function</span> <span class="name">setRGBA</span>(ctx, r, g, b, a) {
        <span class="keyword">if</span>(<span class="name">a</span> <span class="operator">&lt;</span> <span class="number">0</span> <span class="operator">||</span> <span class="name">a</span> <span class="operator">&gt;</span> <span class="number">255</span>) {
            <span class="name">console</span>.<span class="name">error</span>(<span class="string">&quot;setRGBA: alpha value out of bounds&quot;</span>);
            <span class="keyword">return</span>;
        }
        <span class="name">ctx</span>.<span class="name">globalAlpha</span> <span class="operator">=</span> <span class="name">a</span> <span class="operator">/</span> <span class="number">255.0</span>;
        <span class="name">ctx</span>.<span class="name">fillStyle</span> <span class="operator">=</span> <span class="name">ctx</span>.<span class="name">strokeStyle</span> <span class="operator">=</span> <span class="name">makeHtmlColorString</span>(<span class="name">r</span>, <span class="name">g</span>, <span class="name">b</span>);
    }

    <span class="comment">//Fill the whole Canvas with the provided RGB color</span>
    <span class="keyword">function</span> <span class="name">clear</span>(r,g,b) {
        var ctx = <span class="name">getContext</span>(<span class="string">&quot;2d&quot;</span>);
        <span class="name">setRGBA</span>(<span class="name">ctx</span>, <span class="name">r</span>,<span class="name">g</span>,<span class="name">b</span>,<span class="number">255</span>);
        <span class="name">ctx</span>.<span class="name">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="name">width</span>, <span class="name">height</span>);
    }

    <span class="comment">//Flip the framebuffer and therefor display what has been rendered off-screen</span>
    <span class="keyword">function</span> <span class="name">flip</span>() {
        <span class="name">requestPaint</span>();
    }

    <span class="comment">//the actual code drawing a line using the 2d graphics context</span>
    <span class="keyword">function</span> <span class="name">lineRGBA</span>(x1, y1, x2, y2, r, g, b, a) {
        var ctx = <span class="name">getContext</span>(<span class="string">&quot;2d&quot;</span>);
        <span class="name">setRGBA</span>(<span class="name">ctx</span>, <span class="name">r</span>, <span class="name">g</span>, <span class="name">b</span>, <span class="name">a</span>);
        <span class="name">ctx</span>.<span class="name">beginPath</span>();
        <span class="name">ctx</span>.<span class="name">moveTo</span>(<span class="name">x1</span>, <span class="name">y1</span>);
        <span class="name">ctx</span>.<span class="name">lineTo</span>(<span class="name">x2</span>, <span class="name">y2</span>);
        <span class="name">ctx</span>.<span class="name">stroke</span>();
    }
}</pre>
</div>
<!-- @@@write_qml_canvas.html -->
</body>
</html>
