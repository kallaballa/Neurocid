<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- sdlgfx-port.qdoc -->
  <title>Chapter 3: Write a QML Canvas object that mimics a SDL_gfx-like API | felgo-neurocidd</title>
</head>
<body>
<div class="sidebar"><div class="sidebar-content" id="sidebar-content"></div></div>
<h1 class="title">Chapter 3: Write a QML Canvas object that mimics a SDL_gfx-like API</h1>
<span class="subtitle"></span>
<!-- $$$write_qml_canvas.html-description -->
<div class="descr"> <a name="details"></a>
<p>SDL_gfx provides a simple and straight-forward {https://www.ferzkopp.net/Software/SDL_gfx-2.0/Docs/html/_s_d_l__gfx_primitives_8h.html}{API) for rasterising vector graphics. What we need to do is extend a QML Canvas with methods resembling the SDL_gfx-functions we require. Let's say for the sake of simplicity we only require straight-line rendering. The following sections shows an example of QML Canvas that supports exactly that. Please note that the renderTarget and renderStrategy are educated guesses and that he helper functions preceeding the function lineRGBA are required to generate html color-hex-strings (e.g: &quot;#ff0000&quot; for pure red), to clear the whole canvas and to control the framebuffer. You can find the full (and abstracted implementation) in <a href="qml-gfxcanvas.html">GfxCanvas</a>.qml</p>
<pre class="cpp">Canvas {
    renderTarget: Canvas<span class="operator">.</span>Image;
    renderStrategy: Canvas<span class="operator">.</span>Immediate;
    <span class="comment">//VERY important. we need the objectName so we can find the object in the C++ code.</span>
    objectName: <span class="string">&quot;gfxCanvas&quot;</span>

    <span class="comment">//Creates a hex string from an integer value with a value from 0 to 255. If the resulting</span>
    <span class="comment">//string consists of only one character a leading zero is added.</span>
    function makePadded8BitHexString(v) {
        <span class="keyword">if</span>(v <span class="operator">&lt;</span> <span class="number">0</span> <span class="operator">|</span><span class="operator">|</span> v <span class="operator">&gt;</span> <span class="number">255</span>) {
            console<span class="operator">.</span>error(<span class="string">&quot;makePadded8BitHexString: value out of bounds&quot;</span>);
            <span class="keyword">return</span> <span class="string">&quot;00&quot;</span>;
        } <span class="keyword">else</span> {
            var vHex <span class="operator">=</span> v<span class="operator">.</span>toString(<span class="number">16</span>);
            <span class="keyword">if</span>(vHex<span class="operator">.</span>length <span class="operator">=</span><span class="operator">=</span><span class="operator">=</span> <span class="number">1</span>) {
                <span class="keyword">return</span> <span class="string">&quot;0&quot;</span> <span class="operator">+</span> vHex;
            } <span class="keyword">else</span> {
                <span class="keyword">return</span> vHex;
            }
        }
    }

    <span class="comment">//Creates an html like rgb hex-string. e.g.: &quot;#ff0000&quot; for pure red</span>
    function makeHtmlColorString(r<span class="operator">,</span> g<span class="operator">,</span> b) {
        <span class="keyword">return</span> <span class="string">&quot;#&quot;</span> <span class="operator">+</span> makePadded8BitHexString(r) <span class="operator">+</span>
                makePadded8BitHexString(g) <span class="operator">+</span>
                makePadded8BitHexString(b)
    }

    <span class="comment">//Sets the fill and stroke color of the 2d context.</span>
    function setRGBA(ctx<span class="operator">,</span> r<span class="operator">,</span> g<span class="operator">,</span> b<span class="operator">,</span> a) {
        <span class="keyword">if</span>(a <span class="operator">&lt;</span> <span class="number">0</span> <span class="operator">|</span><span class="operator">|</span> a <span class="operator">&gt;</span> <span class="number">255</span>) {
            console<span class="operator">.</span>error(<span class="string">&quot;setRGBA: alpha value out of bounds&quot;</span>);
            <span class="keyword">return</span>;
        }
        ctx<span class="operator">.</span>globalAlpha <span class="operator">=</span> a <span class="operator">/</span> <span class="number">255.0</span>;
        ctx<span class="operator">.</span>fillStyle <span class="operator">=</span> ctx<span class="operator">.</span>strokeStyle <span class="operator">=</span> makeHtmlColorString(r<span class="operator">,</span> g<span class="operator">,</span> b);
    }

    <span class="comment">//Fill the whole Canvas with the provided RGB color</span>
    function clear(r<span class="operator">,</span>g<span class="operator">,</span>b) {
        var ctx <span class="operator">=</span> getContext(<span class="string">&quot;2d&quot;</span>);
        setRGBA(ctx<span class="operator">,</span> r<span class="operator">,</span>g<span class="operator">,</span>b<span class="operator">,</span><span class="number">255</span>);
        ctx<span class="operator">.</span>fillRect(<span class="number">0</span><span class="operator">,</span> <span class="number">0</span><span class="operator">,</span> width<span class="operator">,</span> height);
    }

    <span class="comment">//Flip the framebuffer and therefor display what has been rendered off-screen</span>
    function flip() {
        requestPaint();
    }

    <span class="comment">//the actual code drawing a line using the 2d graphics context</span>
    function lineRGBA(x1<span class="operator">,</span> y1<span class="operator">,</span> x2<span class="operator">,</span> y2<span class="operator">,</span> r<span class="operator">,</span> g<span class="operator">,</span> b<span class="operator">,</span> a) {
        var ctx <span class="operator">=</span> getContext(<span class="string">&quot;2d&quot;</span>);
        setRGBA(ctx<span class="operator">,</span> r<span class="operator">,</span> g<span class="operator">,</span> b<span class="operator">,</span> a);
        ctx<span class="operator">.</span>beginPath();
        ctx<span class="operator">.</span>moveTo(x1<span class="operator">,</span> y1);
        ctx<span class="operator">.</span>lineTo(x2<span class="operator">,</span> y2);
        ctx<span class="operator">.</span>stroke();
    }
}</pre>
</div>
<!-- @@@write_qml_canvas.html -->
</body>
</html>
